<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch API - Week 09 Example</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        h1 { color: #00bcd4; }
        .output { background: #2c3e50; color: #2ecc71; padding: 20px; border-radius: 10px; font-family: monospace; white-space: pre-wrap; margin: 15px 0; min-height: 150px; max-height: 400px; overflow-y: auto; }
        button { background: #00bcd4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #00acc1; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        .demo-area { background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .loading { color: #f39c12; }
        .error { color: #e74c3c; }
        .success { color: #2ecc71; }
        .user-card { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; }
        .user-card img { width: 50px; height: 50px; border-radius: 50%; }
        #userCards { display: none; }
        #userCards.visible { display: block; }
    </style>
</head>
<body>
    <p><a href="index.html">&larr; Back to Examples</a></p>
    <h1>Fetch API Demo</h1>
    <p>Using <a href="https://jsonplaceholder.typicode.com/" target="_blank">JSONPlaceholder</a> - a free fake API for testing.</p>

    <div class="demo-area">
        <h2>HTTP Methods</h2>
        <button onclick="fetchGet()">GET - Fetch Users</button>
        <button onclick="fetchPost()">POST - Create User</button>
        <button onclick="fetchPut()">PUT - Update User</button>
        <button onclick="fetchDelete()">DELETE - Delete User</button>
    </div>

    <div class="output" id="output">Click a button to make an API request...</div>

    <div class="demo-area">
        <h2>Practical Example: User Cards</h2>
        <button onclick="loadUserCards()" id="loadBtn">Load User Cards</button>
        <div id="userCards"></div>
    </div>

    <div class="demo-area">
        <h2>Error Handling</h2>
        <button onclick="fetchWithError()">Fetch Invalid URL</button>
        <button onclick="fetchNotFound()">Fetch 404</button>
        <button onclick="fetchTimeout()">Fetch with Timeout</button>
    </div>

    <div class="output" id="errorOutput">Click a button to see error handling...</div>

    <script>
        const API_URL = 'https://jsonplaceholder.typicode.com';

        async function fetchGet() {
            const output = document.getElementById('output');
            output.innerHTML = '<span class="loading">Loading...</span>';

            try {
                const response = await fetch(`${API_URL}/users?_limit=3`);

                output.textContent = `// GET Request

fetch('${API_URL}/users?_limit=3')
    .then(response => response.json())
    .then(data => console.log(data));

// Response Status: ${response.status} ${response.statusText}
// Response OK: ${response.ok}

// Response Headers:
// Content-Type: ${response.headers.get('Content-Type')}

// Response Data:
`;
                const data = await response.json();
                output.textContent += JSON.stringify(data, null, 2);
            } catch (error) {
                output.innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        async function fetchPost() {
            const output = document.getElementById('output');
            output.innerHTML = '<span class="loading">Creating user...</span>';

            const newUser = {
                name: 'John Doe',
                email: 'john@example.com',
                username: 'johndoe'
            };

            try {
                const response = await fetch(`${API_URL}/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newUser)
                });

                const data = await response.json();

                output.textContent = `// POST Request - Create New Resource

const newUser = {
    name: 'John Doe',
    email: 'john@example.com',
    username: 'johndoe'
};

fetch('${API_URL}/users', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify(newUser)
})
.then(response => response.json())
.then(data => console.log(data));

// Response Status: ${response.status} ${response.statusText}

// Created User (server assigned ID):
${JSON.stringify(data, null, 2)}

// Note: JSONPlaceholder doesn't actually save data,
// but returns what would be saved with an ID.`;
            } catch (error) {
                output.innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        async function fetchPut() {
            const output = document.getElementById('output');
            output.innerHTML = '<span class="loading">Updating user...</span>';

            const updatedUser = {
                id: 1,
                name: 'Updated Name',
                email: 'updated@example.com',
                username: 'updateduser'
            };

            try {
                const response = await fetch(`${API_URL}/users/1`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedUser)
                });

                const data = await response.json();

                output.textContent = `// PUT Request - Update Entire Resource

const updatedUser = {
    id: 1,
    name: 'Updated Name',
    email: 'updated@example.com',
    username: 'updateduser'
};

fetch('${API_URL}/users/1', {
    method: 'PUT',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify(updatedUser)
})
.then(response => response.json())
.then(data => console.log(data));

// Response Status: ${response.status} ${response.statusText}

// Updated User:
${JSON.stringify(data, null, 2)}

// PUT replaces the entire resource
// Use PATCH for partial updates`;
            } catch (error) {
                output.innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        async function fetchDelete() {
            const output = document.getElementById('output');
            output.innerHTML = '<span class="loading">Deleting user...</span>';

            try {
                const response = await fetch(`${API_URL}/users/1`, {
                    method: 'DELETE'
                });

                output.textContent = `// DELETE Request - Remove Resource

fetch('${API_URL}/users/1', {
    method: 'DELETE'
})
.then(response => {
    if (response.ok) {
        console.log('Deleted successfully');
    }
});

// Response Status: ${response.status} ${response.statusText}
// Response OK: ${response.ok}

// DELETE requests typically return:
// - 200 OK with response body
// - 204 No Content (empty body)
// - 404 Not Found if resource doesn't exist

// The user with ID 1 would be deleted.
// (JSONPlaceholder simulates this but doesn't actually delete)`;
            } catch (error) {
                output.innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        async function loadUserCards() {
            const container = document.getElementById('userCards');
            const btn = document.getElementById('loadBtn');

            btn.disabled = true;
            btn.textContent = 'Loading...';
            container.innerHTML = '';
            container.classList.add('visible');

            try {
                const response = await fetch(`${API_URL}/users?_limit=5`);
                const users = await response.json();

                users.forEach(user => {
                    const card = document.createElement('div');
                    card.className = 'user-card';
                    card.innerHTML = `
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=00bcd4&color=fff" alt="${user.name}">
                        <div>
                            <strong>${user.name}</strong><br>
                            <small>${user.email}</small><br>
                            <small>@${user.username} | ${user.company.name}</small>
                        </div>
                    `;
                    container.appendChild(card);
                });

                btn.textContent = 'Reload Users';
                btn.disabled = false;
            } catch (error) {
                container.innerHTML = `<p class="error">Failed to load users: ${error.message}</p>`;
                btn.textContent = 'Try Again';
                btn.disabled = false;
            }
        }

        async function fetchWithError() {
            const output = document.getElementById('errorOutput');
            output.innerHTML = '<span class="loading">Fetching invalid URL...</span>';

            try {
                const response = await fetch('https://invalid-domain-that-does-not-exist.com/api');
                const data = await response.json();
                output.textContent = JSON.stringify(data);
            } catch (error) {
                output.innerHTML = `<span class="error">// Network Error Caught!</span>

try {
    const response = await fetch('https://invalid-domain.com/api');
} catch (error) {
    console.error(error);
}

// Error Type: ${error.name}
// Error Message: ${error.message}

// Network errors (DNS failure, no internet, CORS) throw exceptions
// Always wrap fetch in try/catch!`;
            }
        }

        async function fetchNotFound() {
            const output = document.getElementById('errorOutput');
            output.innerHTML = '<span class="loading">Fetching non-existent resource...</span>';

            try {
                const response = await fetch(`${API_URL}/users/99999`);

                output.textContent = `// 404 Not Found

const response = await fetch('${API_URL}/users/99999');

// Response Status: ${response.status}
// Response OK: ${response.ok}

// IMPORTANT: fetch() does NOT throw on HTTP errors!
// A 404 response is still a successful fetch.

// You must check response.ok or response.status:
if (!response.ok) {
    throw new Error(\`HTTP error! status: \${response.status}\`);
}

// Or check specific status:
if (response.status === 404) {
    console.log('Resource not found');
}`;

                // Show what the response contains
                const data = await response.json();
                output.textContent += `\n\n// Response body (empty object from JSONPlaceholder):
${JSON.stringify(data)}`;
            } catch (error) {
                output.innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        async function fetchTimeout() {
            const output = document.getElementById('errorOutput');
            output.innerHTML = '<span class="loading">Fetching with timeout...</span>';

            // Create timeout using AbortController
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 100); // 100ms timeout

            try {
                const response = await fetch(`${API_URL}/users`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                const data = await response.json();
                output.textContent = `Request completed before timeout:\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                if (error.name === 'AbortError') {
                    output.innerHTML = `<span class="error">// Request Timed Out!</span>

// Using AbortController for timeout:

const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 100);

try {
    const response = await fetch(url, {
        signal: controller.signal
    });
    clearTimeout(timeoutId);
} catch (error) {
    if (error.name === 'AbortError') {
        console.log('Request timed out!');
    }
}

// Error Name: ${error.name}
// The request was aborted after 100ms

// AbortController can also be used to cancel requests:
// controller.abort(); // Cancel manually`;
                } else {
                    output.innerHTML = `<span class="error">Error: ${error.message}</span>`;
                }
            }
        }
    </script>

    <hr>
    <p><a href="index.html">&larr; Back to Examples</a></p>
</body>
</html>
